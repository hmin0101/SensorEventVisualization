<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MultiScreen</title>

    <link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/font-awesome/css/font-awesome.css">

    <link rel="stylesheet" href="/stylesheets/animate.css">
    <link rel="stylesheet" href="/stylesheets/style.css">

    <link rel="stylesheet" href="/stylesheets/toastr-2.1.3.min.css">

    <style>
        .flex {
            display: flex;
        }
        .flex-item-20 {
            flex: 20%;
            max-width: 20%;
        }
        .flex-item-25 {
            flex: 25%;
            max-width: 25%;
        }
        .flex-item-50 {
            flex: 50%;
            max-width: 50%;
        }
        .flex-item-75 {
            flex: 75%;
            max-width: 75%;
        }
        .flex .input-group {
            display: block;
            width: 100%;
        }
        .flex > .flex-item-20,
        .flex > .flex-item-25,
        .flex > .flex-item-50,
        .flex > .flex-item-75 {
            margin-left: 10px;
            margin-right: 10px;
        }
        .flex > .flex-item-20:first-child,
        .flex > .flex-item-25:first-child,
        .flex > .flex-item-50:first-child,
        .flex > .flex-item-75:first-child {
            margin-left: 0;
            margin-right: 10px;
        }
        .flex > .flex-item-20:last-child,
        .flex > .flex-item-25:last-child,
        .flex > .flex-item-50:last-child,
        .flex > .flex-item-75:last-child {
            margin-left: 10px;
            margin-right: 0;
        }

        .form-subject {
            display: block;
            margin-bottom: 4px;
            font-size: 10px;
            font-weight: 100;
        }
        .form-control {
            font-size: 12px;
        }

        .arrange-area {
            display: flex;
            padding: 20px 10px;
        }
        .arrange-area .sub-item {
            border: 1px solid #e7eaec;
            flex: 1;
            margin: 0 10px;
            padding: 13px;
            text-align: center;
            box-shadow: 0 1px 1px rgba(60, 60, 60, 0.3), 0 1px 2px rgba(60, 60, 60, 0.22);
        }
        .sub-item .device-name {
            margin: 0 0 10px 0;
            font-size: 17px;
            font-weight: 400;
        }
        .sub-item .input-group {
            display: inline;
        }
        .sub-item .dropdown-toggle {
            font-size: 9px;
            font-weight: 100;
            padding: 3px 6px;
        }
    </style>
</head>

<body>
<div id="wrapper">

    <% include ./nav %>

    <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
            <nav class="navbar navbar-static-top white-bg" role="navigation" style="margin-bottom: 0">
                <div class="navbar-header navbar-top-left">
                    <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
                </div>
                <ul class="nav navbar-top-links navbar-top-right">
                    <li>
                        <span class="m-r-sm text-muted welcome-message">Welcome to Multiscreen Management Site.</span>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="wrapper wrapper-content">
            <div class="row">
                <div class="col-lg-12">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="ibox">
                                <div class="ibox-title">
                                    <h5>설정된 팝업 내역</h5>
                                    <div class="ibox-tools">
                                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </div>
                                </div>
                                <div class="ibox-content">
                                    <table class="table" id="table-popupList"></table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="ibox">
                                <div class="ibox-title">
                                    <h5>팝업 설정</h5>
                                    <div class="ibox-tools">
                                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </div>
                                </div>
                                <div class="ibox-content">
                                    <div class="flex">
                                        <div class="flex flex-item-25">
                                            <div class="input-group">
                                                <label class="form-subject" for="select-event">Sensor Type</label>
                                                <select class="form-control" id="select-event">
                                                    <option value="ir">IR Sensor</option>
                                                    <option value="laser">Laser Sensor</option>
                                                    <option value="ir2">IR2 Sensor</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="flex flex-item-75">
                                            <div class="flex-item-50">
                                                <div class="input-group">
                                                    <label class="form-subject" for="input-name">Name</label>
                                                    <input class="form-control" id="input-name" placeholder="Input Popup Name"/>
                                                </div>
                                            </div>
                                            <div class="flex-item-50">
                                                <div class="input-group">
                                                    <label class="form-subject" for="input-url">Image Url</label>
                                                    <input class="form-control" id="input-url" placeholder="Input Image Url"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="hr-line-dashed"></div>
                                    <div class="flex">
                                        <div class="flex-item-20">
                                            <div class="input-group">
                                                <label class="form-subject" for="input-x">Position X</label>
                                                <input class="form-control" id="input-x" placeholder="(Default: 0)"/>
                                            </div>
                                        </div>
                                        <div class="flex-item-20">
                                            <div class="input-group">
                                                <label class="form-subject" for="input-y">Position Y</label>
                                                <input class="form-control" id="input-y" placeholder="(Default: 0)"/>
                                            </div>
                                        </div>
                                        <div class="flex-item-20">
                                            <div class="input-group">
                                                <label class="form-subject" for="input-width">Popup Width</label>
                                                <input class="form-control" id="input-width" placeholder="(Default: 1200)"/>
                                            </div>
                                        </div>
                                        <div class="flex-item-20">
                                            <div class="input-group">
                                                <label class="form-subject" for="input-height">Popup Height</label>
                                                <input class="form-control" id="input-height" placeholder="(Default: 1000)"/>
                                            </div>
                                        </div>
                                        <div class="flex-item-20">
                                            <div class="input-group">
                                                <label class="form-subject" for="input-duration">Duration (millisecond)</label>
                                                <input class="form-control" id="input-duration" placeholder="(Default: 2000ms)"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="hr-line-dashed"></div>
                                    <div class="arrange-right">
                                        <button type="button" class="btn btn-w-m btn-primary m-l-sm" id="btn-popup-setting">설정</button>
                                        <button type="button" class="btn btn-w-m btn-white m-r-sm" id="btn-clear">비우기</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="ibox">
                                <div class="ibox-title">
                                    <h5>센서 배치 순서</h5>
                                    <div class="ibox-tools">
                                        <a id="btn-save"><i class="fa fa-save"></i></a>
                                    </div>
                                </div>
                                <div class="ibox-content no-padding">
                                    <div class="arrange-area">
                                        <% for (const elem of deviceList) { %>
                                            <div class="sub-item">
                                                <div class="form-draggable">
                                                    <h5 class="device-name" data-id="<%= elem.id %>"><%= elem.name %></h5>
                                                    <div>
                                                        <div class="input-group m-r-xs">
                                                            <button data-toggle="dropdown" class="btn btn-white btn-sm dropdown-toggle" type="button" id="mapping-sensor">Sensor1</button>
                                                            <ul class="dropdown-menu">
                                                                <li><a>Sensor1</a></li>
                                                                <li><a>Sensor2</a></li>
                                                                <li><a>Sensor3</a></li>
                                                                <li><a>Sensor4</a></li>
                                                            </ul>
                                                        </div>
                                                        <div class="input-group m-l-xs">
                                                            <button data-toggle="dropdown" class="btn btn-white btn-sm dropdown-toggle" type="button" id="mapping-type">IR</button>
                                                            <ul class="dropdown-menu">
                                                                <li><a>IR</a></li>
                                                                <li><a>IR2:0ch</a></li>
                                                                <li><a>IR2:1ch</a></li>
                                                                <li><a>IR2:2ch</a></li>
                                                                <li><a>IR2:3ch</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Mainly scripts -->
<script src="/javascripts/jquery-3.1.1.min.js"></script>
<script src="/javascripts/bootstrap.js"></script>
<script src="/javascripts/jquery.metisMenu.js"></script>
<script src="/javascripts/jquery.slimscroll.min.js"></script>
<!-- Custom and plugin javascript -->
<script src="/javascripts/inspinia.js"></script>
<script src="/javascripts/pace.min.js"></script>
<!-- jQuery UI -->
<script src="/javascripts/jquery-ui.min.js"></script>
<!-- FooTable -->
<script src="/javascripts/footable-3.1.6.js"></script>
<!-- jQuery Touch Punch UI -->
<script src="/javascripts/jquery-ui-touch-punch.min.js"></script>
<script>
    $(document).ready(() => {

        let currentSettingId = null;

        const ft = FooTable.init("#table-popupList", {
            pagination: {
                paging: true,
                size: 10,
                limit: 10
            },
            columns: [
                {name: "id", title: "", classes: "hidden"},
                {name: "type", title: "Sensor Type", type: "string", classes: "enable-click"},
                {name: "name", title: "Name", classes: "enable-click"},
                {name: "url", title: "", classes: "hidden"},
                {name: "pos_x", title: "", classes: "hidden"},
                {name: "pos_y", title: "", classes: "hidden"},
                {name: "width", title: "", classes: "hidden"},
                {name: "height", title: "", classes: "hidden"},
                {name: "duration", title: "", classes: "hidden"},
            ],
            rows: $.get('/setting/popup/list')
        });

        $(document).on('click', '.table .enable-click', function(e) {
            const row = FooTable.getRow(this).value;

            $('#select-event option').each(function(e) {
                const type = $(this).val();
                if (type === row.type) {
                    $(this).prop("selected", true);
                }
            });
            currentSettingId = row.id;
            $('#input-name').val(row.name);
            $('#input-url').val(row.url);
            $('#input-x').val(row.pos_x);
            $('#input-y').val(row.pos_y);
            $('#input-width').val(row.width);
            $('#input-height').val(row.height);
            $('#input-duration').val(row.duration);
        });

        $('#btn-clear').on('click', function(e) {
            clearSettingInfo();
        });

        $('#btn-popup-setting').on('click', function(e) {
            const option = {
                id: currentSettingId,
                type: $('#select-event').val(),
                name: $('#input-name').val(),
                url: $('#input-url').val(),
                pos_x: $('#input-x').val(),
                pos_y: $('#input-y').val(),
                width: $('#input-width').val(),
                height: $('#input-height').val(),
                duration: $('#input-duration').val(),
            };

            if (blankCheck(option.pos_x)) option.pos_x = 0;
            if (blankCheck(option.pos_y)) option.pos_x = 0;
            if (blankCheck(option.width)) option.pos_x = 1200;
            if (blankCheck(option.height)) option.pos_x = 1000;
            if (blankCheck(option.duration)) option.duration = 2000;
            if (blankCheck(option.name)) {
                alert("Setting Name을 입력해주세요.");
            } else if (blankCheck(option.url)) {
                alert("Popup Url을 입력해주세요.");
            } else {
                if (option.id === null) {
                    $.ajax({
                        type: "POST",
                        url: "/setting/popup/add",
                        data: "option="+JSON.stringify(option),
                        success: function(result) {
                            if (result.result) {
                                $.get('/setting/popup/list', function(list) {
                                    ft.rows.load(list);
                                });
                                clearSettingInfo();
                                alert("Setting 추가 완료");
                            } else {
                                alert(result.message);
                            }
                        }
                    });
                } else {
                    $.ajax({
                        type: "POST",
                        url: "/setting/popup/update",
                        data: "option="+JSON.stringify(option),
                        success: function(result) {
                            if (result.result) {
                                $.get('/setting/popup/list', function(list) {
                                    ft.rows.load(list);
                                });
                                clearSettingInfo();
                                alert("Setting 업데이트 완료");
                            } else {
                                alert(result.message);
                            }
                        }
                    });
                }
            }
        });

        function clearSettingInfo() {
            currentSettingId = null;
            $('#select-event option:eq(0)').prop('selected', true);
            $('#input-name').val("");
            $('#input-url').val("");
            $('#input-x').val("");
            $('#input-y').val("");
            $('#input-width').val("");
            $('#input-height').val("");
            $('#input-duration').val("");
        }

        // Select Device
        $('#select-device').on("change", function(e) {
            const deviceId = $(this).val();

            $.ajax({
                type: "POST",
                url: "/choice/device",
                data: "type=setting&id="+deviceId,
                success: function(result) {
                    if (result) {
                        ft.rows.load(result.list);
                    } else {
                        alert(result.message);
                    }
                }
            });
        });

        // Div 를 움직일 수 있게 됨
        WinMove();

        $('#btn-save').on('click', function(e) {
            const setting = {
                arrange: [],
                mapping: {}
            };

            $('.arrange-area .form-draggable').each(function() {
                const deviceName = $(this).find('.device-name').text();
                const sensor = $(this).find('#mapping-sensor').text();
                const type = $(this).find('#mapping-type').text();

                setting.arrange.push(deviceName);

                if (type !== "IR") {
                    const split = type.split(':');
                    setting.mapping[deviceName] = {
                        sensor: sensor,
                        type: split[0],
                        channel: split[1]
                    };
                } else {
                    setting.mapping[deviceName] = {
                        sensor: sensor,
                        type: type,
                        channel: 0
                    };
                }
            });

            $.ajax({
                type: "POST",
                url: "http://192.168.0.14:9000/setting/arrange/device",
                data: "setting="+JSON.stringify(setting),
                // success: function(result) {
                //     alert(result);
                // }
            });
        });

        $('.dropdown-menu li a').on('click', function(e) {
            const value = $(this).text();
            const form = $(this).parent().parent().parent();
            form.find('.dropdown-toggle').text(value);
        });

    });

    function blankCheck(value) {
        if (value === "" || value === null) {
            return true;
        }
        const blankPattern = /^\s+|\s+$/g;
        return value.replace(blankPattern, "") === "";
    }
</script>
</body>
</html>
